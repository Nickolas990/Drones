# Kafka Drones Monitoring & Reporting Service

## Описание

**Kafka Drones Monitoring & Reporting Service** — это профессиональное Java-приложение для имитации работы флота дронов, публикации телеметрии и координат дронов в Apache Kafka и формирования отчетности и алертов в реальном времени с поддержкой параллельных потребителей и устойчивостью к сбоям.

Архитектура поддерживает:
- распределённую генерацию событий от дронов (потоковые Kafka-producers)
- параллельную обработку сообщений для каждого топика (каждая партиция — отдельный consumer)
- систему алертов по температуре с отслеживанием скользящего среднего
- формирование CSV-отчётов по доставкам в реальном времени на основе данных сразу из нескольких топиков
- автоматическую балансировку и восстановление consumer-потоков при падениях

---

## Основные компоненты

- **Продюсер дронов** (многопоточный, каждому дрону — свои интервалы событий)
    - drone_metrics — температуры (каждые 3 сек)
    - drone_positions — координаты (каждые 0.8 сек)
    - drone_delivery_statuses — статусы доставок (в среднем раз в минуту)
- **Интеллектуальный Alert Consumer**
    - Считает среднюю температуру дрона за минуту
    - Генерирует алерт в консоль и лог-файл, если порог превышен
- **Report Consumer**
    - Формирует CSV-отчет по доставке с актуальными данными, когда приходит событие в drone_delivery_statuses
- **Параллельная обработка**
    - Количество consumer-ов динамически соответствует числу партиций в топиках
    - Каждый consumer может быть "убит" случайным фейлом, затем перезапускается, а Kafka корректно перебалансирует партиции
- **Грейсфул инициализация и shutdown**
    - Все ресурсы корректно освобождаются, поддерживается завершение через консольную команду `exit`
- **Конфигурация через аргументы**
    - Bootstrap servers Kafka, параметры можно подавать через параметры запуска

---

## Как запустить

### 1. Разверните Kafka-кластер

Рекомендуется 3-брокерный кластер с корректными `KAFKA_ADVERTISED_LISTENERS`.  
Все переменные, проброс портов и конфиги должны позволять подключение с вашего хоста через `localhost:9092,9093,9094`.

### 2. Запуск продюсера

java -jar DronesProducer-1.0-SNAPSHOT.jar --kafka_bootstrap_servers:localhost:9092,localhost:9093,localhost:9094

### 3. Запуск consumer-отчётчика и alert-системы

java -jar DronesConsumers-1.0-SNAPSHOT.jar --kafka_bootstrap_servers:localhost:9092,localhost:9093,localhost:9094

- После запуска можно вводить `exit`, чтобы завершить работу аккуратно;
- Приложение автоматически определяет число партиций и запускает столько consumer-потоков, сколько требуется;
- Реализовано автоматическое восстановление приличных consumer-потоков с логированием ребалансировок;
- Все алерты (по температуре) пишутся в `drone_temperature_alerts.log`, отчёты доставок — в CSV-файл `delivery_report.csv`.

---

## Структура сообщений и файлы

**Температура / drone_metrics** — JSON  
{ "drone": "drone-3", "temperature": 41.2 }

**Позиция / drone_positions** — JSON  
{ "drone": "drone-3", "lat": 55.2, "lon": 39.1 }

**Доставка / drone_delivery_statuses** — JSON
{ "drone": "drone-3", "destination": "Казань" }

**Log-файл алертов:**  
`drone_temperature_alerts.log`

**CSV-отчет**  
`delivery_report.csv`, формат:  
drone;destination;time;lat,lon;temperature
drone-5;Москва;2025-07-20 21:14:23;55.25,37.36;47.3


---

## Резервирование, отказоустойчивость и перебалансировка

- **Каждый consumer** — отдельный поток с уникальным instance id (`group.instance.id`), что гарантирует закрепление партиции за consumer’ом до падения.
- **Падение**: consumer генерирует случайное исключение с вероятностью 2%; это приводит к перебалансировке партиций Kafka и перезапуску consumer в сервисе.
- **Все перебалансировки** логируются в консоль.

---

## Как завершить приложение

Введите `exit` в консоль consumer-приложения — будет выполнено корректное завершение всех потоков, consumer-ов и ресурсов.

---

## Структура проекта

- `model/` — классы-сообщения (POJO)
- `producer/` — генерация и отправка событий
- `consumer/` — классы обработки, алертов, отчетов, менеджмент consumer’ов
- `service/` — логика жизненного цикла и управления потоками
- `util/` — утилиты (например, получение числа партиций)
- `config/` — работа с аргументами запуска/конфигами

---

## Требования и зависимости

- Java 17+
- Kafka-clients 3.7.0+ / 3.8.0+
- com.github.javafaker
- slf4j/logback (или совместимый логгер)
- Jackson

---

## Разработка и тесты

Рекомендуется запускать в dev-кластере Kafka (например, через Docker Compose c 3 брокерами).  
Тщательно протестировано динамическое восстановление после падения consumer-ов, поддержка консистентности и out-of-the-box работа с real-time данными по дронам.

---

## Контакты и лицензия

Проект развиваемый, открыт к PR и новым фичам.